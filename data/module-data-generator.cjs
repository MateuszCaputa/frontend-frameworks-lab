const fs = require("fs");
const path = require("path");

// --- Configuration ---
const DOMAIN = "wsei.edu.pl";
const OUTPUT_FILE_PATH = path.join(__dirname, "..", "src", "module-data.js");
const NAMES_FILE_PATH = path.join(__dirname, "names.txt");

// --- Helper Functions ---

/**
 * Generates a random phone number in the format XXX-XXX-XXX
 * @returns {string} A random phone number.
 */
const generateRandomPhone = () => {
  const randomDigits = () => Math.floor(100 + Math.random() * 900);
  return `${randomDigits()}-${randomDigits()}-${randomDigits()}`;
};

/**
 * Generates a random birth date between 2000 and 2005.
 * @returns {string} A random date in YYYY-MM-DD format.
 */
const generateRandomDate = () => {
  const start = new Date(2000, 0, 1).getTime();
  const end = new Date(2005, 11, 31).getTime();
  const randomTime = start + Math.random() * (end - start);
  return new Date(randomTime).toISOString().split("T")[0];
};

// --- Main Script Logic ---

// (Lab 1, Task 2 & 5)
// Read count from command-line argument
const count = Number(process.argv[2]);

if (isNaN(count) || count <= 0) {
  console.error("Error: Please provide a valid number of objects to generate.");
  process.exit(1); // Exit with an error code
}

// Check if file already exists
if (fs.existsSync(OUTPUT_FILE_PATH)) {
  console.log(
    `[Skipped] ${path.basename(
      OUTPUT_FILE_PATH
    )} already exists. Delete it to regenerate.`
  );
  process.exit(0); // Exit successfully
}

// Read names file and generate data
fs.readFile(NAMES_FILE_PATH, "utf8", (err, data) => {
  if (err) {
    console.error(`Error reading names file: ${err}`);
    return;
  }

  // Process names from the file
  const names = data
    .split(/\s+/) // Split by any whitespace (space, newline, etc.)
    .map((s) => s.trim())
    .filter((n) => n.length > 0);
  if (names.length === 0) {
    console.error("Error: The names file is empty.");
    return;
  }

  let people = [];
  let nameCounts = {}; // Track name occurrences for unique emails

  for (let i = 0; i < count; i++) {
    const randomName = names[Math.floor(Math.random() * names.length)];

    // Ensure unique email if name repeats
    nameCounts[randomName] = (nameCounts[randomName] || 0) + 1;
    const countSuffix =
      nameCounts[randomName] > 1 ? nameCounts[randomName] : "";
    const email = `${randomName.toLowerCase()}${countSuffix}@${DOMAIN}`;

    people.push({
      id: i + 1,
      name: randomName,
      birthDate: generateRandomDate(),
      email: email,
      phone: generateRandomPhone(),
    });
  }

  // Format content for module-data.js
  let content = `// Generated by module-data-generator.cjs\n`;
  content += `export const people = ${JSON.stringify(people, null, 4)};\n`;

  // Write the content to the output file
  fs.writeFile(OUTPUT_FILE_PATH, content, (err) => {
    if (err) {
      console.error(`Error writing file: ${err}`);
    } else {
      console.log(
        `Successfully generated ${people.length} objects in ${path.basename(
          OUTPUT_FILE_PATH
        )}`
      );
    }
  });
});
